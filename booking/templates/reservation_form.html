{% extends "base.html" %}
{% block content %}
<div class="app-form-wrapper">
  <section class="app-form-card">
    <header class="app-form-header">
      <h1>{{ form_title|default:"Nueva reserva" }}</h1>
      <p>Coordina salones, horarios y materiales utilizando la misma experiencia del registro.</p>
    </header>

    <form method="post" class="app-form">
      {% csrf_token %}

      <fieldset class="app-form-section">
        <legend>Información de la reserva</legend>
        <div class="app-form-grid">
          <div class="app-form-field">
            <label for="{{ form.room.id_for_label }}">Salón</label>
            {{ form.room }}
            {% if form.room.errors %}
              <div class="error-messages">
                {% for error in form.room.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="app-form-field">
            <label for="{{ form.course.id_for_label }}">{{ form.course.label }}</label>
            {{ form.course }}
            {% if form.course.errors %}
              <div class="error-messages">
                {% for error in form.course.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
            <small class="help-text">{{ form.course.help_text }}</small>
          </div>

          <div class="app-form-field">
            <label for="{{ form.subject.id_for_label }}">{{ form.subject.label }}</label>
            {{ form.subject }}
            {% if form.subject.errors %}
              <div class="error-messages">
                {% for error in form.subject.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
            <small class="help-text">{{ form.subject.help_text }}</small>
          </div>

          <div class="app-form-field">
            <label for="{{ form.date.id_for_label }}">Fecha</label>
            {{ form.date }}
            {% if form.date.errors %}
              <div class="error-messages">
                {% for error in form.date.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
            <small class="help-text">Elige la fecha para cargar los bloques disponibles de ese día.</small>
          </div>

          <div class="app-form-field app-form-field--full">
            <label for="block-select">Bloque</label>
            <select id="block-select" class="filter-select" required></select>
            <small id="block-help" class="help-text"></small>
          </div>

          <div class="app-form-field">
            <label for="{{ form.start_time.id_for_label }}">Inicio</label>
            {{ form.start_time }}
            {% if form.start_time.errors %}
              <div class="error-messages">
                {% for error in form.start_time.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="app-form-field">
            <label for="{{ form.end_time.id_for_label }}">Término</label>
            {{ form.end_time }}
            {% if form.end_time.errors %}
              <div class="error-messages">
                {% for error in form.end_time.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      <fieldset class="app-form-section">
        <legend>Materiales requeridos</legend>
        <p class="app-form-description">Selecciona la cantidad de materiales que necesitas para tu reserva.</p>

        <div class="materials-grid">
          {% for material, quantity in material_inputs %}
            <div class="material-item">
              <label class="material-label">{{ material.name }}</label>
              <input
                type="number"
                name="qty_{{ material.id }}"
                min="0"
                max="50"
                placeholder="0"
                class="material-input"
                value="{{ quantity|default_if_none:'' }}">
            </div>
          {% endfor %}
        </div>
      </fieldset>

      <div class="app-form-actions">
        <button type="submit" class="app-form-button app-form-button--primary">
          {{ submit_label|default:"Crear reserva" }}
        </button>
        <a href="{{ cancel_url|default:'/reservas/' }}" class="app-form-button app-form-button--secondary">
          Cancelar
        </a>
      </div>
    </form>
  </section>
</div>

<!-- ==================== LÓGICA DE BLOQUES (JS) ==================== -->
<script>
  // Horarios por bloque
  const BLOQUES_BASE = [
    ["08:00","08:45"], // 1
    ["08:45","09:30"], // 2
    ["09:50","10:35"], // 3
    ["10:35","11:20"], // 4
    ["11:35","12:20"], // 5
    ["12:20","13:05"], // 6
    ["13:05","13:50"], // 7
    ["13:50","14:35"], // 8
    ["14:35","15:20"], // 9
    ["15:20","16:05"], // 10
    ["16:05","16:50"], // 11
  ];
  // 0=Dom, 1=Lun, 2=Mar, 3=Mié, 4=Jue, 5=Vie, 6=Sáb
  const SCHEDULE = {
    1: BLOQUES_BASE,                                  // Lunes
    2: BLOQUES_BASE,                                  // Martes
    3: BLOQUES_BASE,                                  // Miércoles
    4: [...BLOQUES_BASE, ["17:00","18:00"]],          // Jueves con 12º bloque
    5: BLOQUES_BASE.slice(0, 6),                      // Viernes solo 1–6
  };

  // Helpers fecha -> día de semana
  function parseISO(str){ const [y,m,d]=str.split("-").map(Number); return new Date(y, m-1, d); }
  function weekday(str){ return str ? parseISO(str).getDay() : null; }

  // Campos (asumiendo IDs por defecto de Django)
  const dateInput   = document.getElementById("id_date");
  const startInput  = document.getElementById("id_start_time");
  const endInput    = document.getElementById("id_end_time");
  const blockSelect = document.getElementById("block-select");
  const blockHelp   = document.getElementById("block-help");

  // Evitar edición manual: las horas se derivan del bloque
  [startInput, endInput].forEach(i => { if (i) i.readOnly = true; });

  function setTimes(dayIdx, idx){
    const schedule = SCHEDULE[dayIdx];
    if (!schedule || !schedule[idx]){
      startInput.value = "";
      endInput.value = "";
      blockHelp.textContent = "Selecciona un d\u00eda h\u00e1bil (lunes a viernes).";
      return;
    }
    const [ini, fin] = schedule[idx];
    startInput.value = ini;
    endInput.value   = fin;
    blockHelp.textContent = `Horario del bloque ${idx+1}: ${ini} - ${fin}`;
  }

  function loadBlocksFor(dayIdx){
    blockSelect.innerHTML = "";
    const schedule = SCHEDULE[dayIdx];
    if (!schedule){
      blockSelect.add(new Option("No hay bloques disponibles", "", true, true));
      blockSelect.disabled = true;
      startInput.value = ""; endInput.value = "";
      blockHelp.textContent = "Selecciona un día hábil (lunes a viernes).";
      return;
    }
    blockSelect.disabled = false;
    const currentStart = startInput.value;
    const currentEnd = endInput.value;
    let targetIndex = 0;
    schedule.forEach((range, i) => {
      blockSelect.add(new Option(`Bloque ${i+1}`, String(i+1)));
      if (range[0] === currentStart && range[1] === currentEnd){
        targetIndex = i;
      }
    });
    blockSelect.selectedIndex = targetIndex;
    setTimes(dayIdx, targetIndex);
  }

  if (dateInput){
    // Cuando cambia la fecha
    dateInput.addEventListener("change", () => {
      const d = weekday(dateInput.value);
      loadBlocksFor(d);
    });
    // Si el form recargó con errores y ya hay fecha, cargar bloques
    if (dateInput.value){
      loadBlocksFor(weekday(dateInput.value));
    }else{
      // Vacío por defecto
      blockSelect.add(new Option("Selecciona una fecha primero", "", true, true));
      blockSelect.disabled = true;
    }
  }

  // Cuando cambia el bloque
  blockSelect.addEventListener("change", () => {
    const d = weekday(dateInput.value);
    if (!SCHEDULE[d]) return;
    setTimes(d, blockSelect.selectedIndex);
  });
</script>
{% endblock %}
