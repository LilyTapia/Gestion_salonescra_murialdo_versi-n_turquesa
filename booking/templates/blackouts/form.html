{% extends "base.html" %}
{% block content %}
<div class="app-form-wrapper">
  <section class="app-form-card">
    <header class="app-form-header">
      <h1>{{ title }}</h1>
      <p>Seleccione los detalles del bloqueo.</p>
    </header>

    <form method="post" class="app-form">
      {% csrf_token %}

      <fieldset class="app-form-section">
        <legend>Información del bloqueo</legend>
        <div class="app-form-grid">
          <div class="app-form-field">
            <label for="{{ form.room.id_for_label }}">Salón</label>
            {{ form.room }}
            {% if form.room.errors %}
              <div class="error-messages">
                {% for error in form.room.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
            <small class="help-text">Deja vacío para bloqueo global.</small>
          </div>

          <div class="app-form-field">
            <label for="{{ form.date.id_for_label }}">Fecha</label>
            {{ form.date }}
            {% if form.date.errors %}
              <div class="error-messages">
                {% for error in form.date.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
            <small class="help-text">Elige la fecha para cargar los horarios disponibles del día.</small>
          </div>

          <div class="app-form-field app-form-field--full">
            <label for="block-select">Bloque</label>
            <select id="block-select" class="filter-select" required></select>
            <small id="block-help" class="help-text"></small>
          </div>

          <div class="app-form-field">
            <label for="{{ form.start_time.id_for_label }}">Inicio</label>
            {{ form.start_time }}
            {% if form.start_time.errors %}
              <div class="error-messages">
                {% for error in form.start_time.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="app-form-field">
            <label for="{{ form.end_time.id_for_label }}">Término</label>
            {{ form.end_time }}
            {% if form.end_time.errors %}
              <div class="error-messages">
                {% for error in form.end_time.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      {% if not form.repeat.is_hidden %}
        <fieldset class="app-form-section">
          <legend>Repetición</legend>
          <div class="app-form-grid">
            <div class="app-form-field">
              <label for="{{ form.repeat.id_for_label }}">Frecuencia</label>
              {{ form.repeat }}
              {% if form.repeat.errors %}
                <div class="error-messages">
                  {% for error in form.repeat.errors %}
                    <p class="error">{{ error }}</p>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="app-form-field" id="repeat-until-wrapper">
              <label for="{{ form.repeat_until.id_for_label }}">Repetir hasta</label>
              {{ form.repeat_until }}
              <small class="help-text">{{ form.repeat_until.help_text }}</small>
              {% if form.repeat_until.errors %}
                <div class="error-messages">
                  {% for error in form.repeat_until.errors %}
                    <p class="error">{{ error }}</p>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </fieldset>
      {% else %}
        {{ form.repeat }}
        {{ form.repeat_until }}
      {% endif %}

      <fieldset class="app-form-section">
        <legend>Detalle</legend>
        <div class="app-form-grid">
          <div class="app-form-field app-form-field--full">
            <label for="{{ form.reason.id_for_label }}">Razón</label>
            {{ form.reason }}
            {% if form.reason.errors %}
              <div class="error-messages">
                {% for error in form.reason.errors %}
                  <p class="error">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      {% if form.non_field_errors %}
        <div class="error-messages">
          {% for error in form.non_field_errors %}
            <p class="error">{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}

      <div class="app-form-actions">
        <button type="submit" class="app-form-button app-form-button--primary">
          Guardar
        </button>
        <a href="{% url 'blackout_list' %}" class="app-form-button app-form-button--secondary">
          Cancelar
        </a>
      </div>
    </form>
  </section>
</div>

<script>
  const BLOQUES_BASE = [
    ["08:00","08:45"],
    ["08:45","09:30"],
    ["09:50","10:35"],
    ["10:35","11:20"],
    ["11:35","12:20"],
    ["12:20","13:05"],
    ["13:05","13:50"],
    ["13:50","14:35"],
    ["14:35","15:20"],
    ["15:20","16:05"],
    ["16:05","16:50"],
  ];

  const SCHEDULE = {
    1: BLOQUES_BASE,
    2: BLOQUES_BASE,
    3: BLOQUES_BASE,
    4: [...BLOQUES_BASE, ["17:00","18:00"]],
    5: BLOQUES_BASE.slice(0, 6),
  };

  const ALL_DAY_VALUE = 'ALL_DAY';

  function parseISO(str){ const [y,m,d]=str.split('-').map(Number); return new Date(y, m-1, d); }
  function weekday(str){ return str ? parseISO(str).getDay() : null; }

  const dateInput   = document.getElementById('id_date');
  const startInput  = document.getElementById('id_start_time');
  const endInput    = document.getElementById('id_end_time');
  const blockSelect = document.getElementById('block-select');
  const blockHelp   = document.getElementById('block-help');
  const repeatField = document.getElementById('id_repeat');
  const repeatUntil = document.getElementById('id_repeat_until');
  const repeatWrapper = document.getElementById('repeat-until-wrapper');

  [startInput, endInput].forEach(i => { if (i) i.readOnly = true; });

  function scheduleFor(dayIdx){
    return SCHEDULE[dayIdx] || null;
  }

  function setTimes(dayIdx, value){
    const daySchedule = scheduleFor(dayIdx);
    if (!daySchedule){ return; }

    if (value === ALL_DAY_VALUE){
      const firstStart = daySchedule[0][0];
      const lastEnd = daySchedule[daySchedule.length - 1][1];
      startInput.value = firstStart;
      endInput.value = lastEnd;
      blockHelp.textContent = `Bloqueo completo del día: ${firstStart} - ${lastEnd}`;
      return;
    }

    const idx = Number(value);
    const [ini, fin] = daySchedule[idx];
    startInput.value = ini;
    endInput.value   = fin;
    blockHelp.textContent = `Horario del bloque ${idx + 1}: ${ini} - ${fin}`;
  }

  function syncBlockFromTimes(dayIdx){
    const daySchedule = scheduleFor(dayIdx);
    if (!startInput || !endInput || !startInput.value || !endInput.value || !daySchedule){
      return false;
    }
    const firstStart = daySchedule[0][0];
    const lastEnd = daySchedule[daySchedule.length - 1][1];
    if (startInput.value === firstStart && endInput.value === lastEnd){
      blockSelect.value = ALL_DAY_VALUE;
      blockHelp.textContent = `Bloqueo completo del día: ${firstStart} - ${lastEnd}`;
      return true;
    }
    const idx = daySchedule.findIndex(([ini, fin]) => ini === startInput.value && fin === endInput.value);
    if (idx >= 0){
      blockSelect.value = String(idx);
      setTimes(dayIdx, String(idx));
      return true;
    }
    return false;
  }

  function loadBlocksFor(dayIdx){

    blockSelect.innerHTML = '';

    const daySchedule = scheduleFor(dayIdx);

    if (!daySchedule){

      blockSelect.add(new Option('Selecciona un día hábil', '', true, true));

      blockSelect.disabled = true;

      if (startInput) startInput.value = '';

      if (endInput) endInput.value = '';

      blockHelp.textContent = 'Solo hay bloques entre lunes y viernes.';

      return;

    }

    blockSelect.disabled = false;

    blockSelect.add(new Option('Bloquear todo el día', ALL_DAY_VALUE));

    daySchedule.forEach((range, i) => {

      blockSelect.add(new Option(`Bloque ${i + 1}`, String(i)));

    });



    if (!syncBlockFromTimes(dayIdx)){

      blockSelect.value = ALL_DAY_VALUE;

      setTimes(dayIdx, ALL_DAY_VALUE);

    }

  }





  if (dateInput){
    dateInput.addEventListener('change', () => {
      const d = weekday(dateInput.value);
      loadBlocksFor(d);
    });
    if (dateInput.value){
      loadBlocksFor(weekday(dateInput.value));
    } else {
      blockSelect.add(new Option('Selecciona una fecha primero', '', true, true));
      blockSelect.disabled = true;
    }
  }

  blockSelect.addEventListener('change', () => {
    const d = weekday(dateInput.value);
    if (!scheduleFor(d)){ return; }
    setTimes(d, blockSelect.value);
  });

  if (repeatField && repeatWrapper){
    function toggleRepeatUntil(){
      const shouldShow = repeatField.value && repeatField.value !== 'none';
      repeatWrapper.style.display = shouldShow ? 'flex' : 'none';
      if (!shouldShow && repeatUntil){ repeatUntil.value = ''; }
    }
    toggleRepeatUntil();
    repeatField.addEventListener('change', toggleRepeatUntil);
  }
</script>
{% endblock %}


