{% extends "base.html" %}
{% block content %}
<div class="admin-container">
  <div class="header-section">
    <h2>Gestión de inventario</h2>
    <a href="/inventario/nuevo/" class="btn btn-primary">Agregar inventario</a>
  </div>

  <!-- Filters and Search -->
  <div class="filters-section">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Buscar por material o salón..." class="search-input">
    </div>
    <div class="filters">
      <select id="roomFilter" class="filter-select">
        <option value="">Todos los salones</option>
        {% for room in rooms %}
          <option value="{{ room.code }}">Salón {{ room.code }}</option>
        {% endfor %}
      </select>
      <select id="materialFilter" class="filter-select">
        <option value="">Todos los materiales</option>
        {% for material in materials %}
          <option value="{{ material.name }}">{{ material.name }}</option>
        {% endfor %}
      </select>
      <select id="availabilityFilter" class="filter-select">
        <option value="">Todas las disponibilidades</option>
        <option value="available">Disponible</option>
        <option value="empty">Agotado</option>
      </select>
    </div>
  </div>

  <div class="availability-controls">
    <form method="get" class="availability-form">
      <div class="availability-inputs">
        <div class="availability-field">
          <label for="availability-date">Fecha</label>
          <input type="date" id="availability-date" name="date" value="{{ selected_date_str }}" />
        </div>
        <div class="availability-field">
          <label for="availability-block">Bloque horario</label>
          {% if has_block_schedule %}
            <select id="availability-block" name="block">
              {% for block in weekday_blocks %}
                <option value="{{ block.index }}" {% if selected_block and selected_block.index == block.index %}selected{% endif %}>{{ block.label }}</option>
              {% endfor %}
            </select>
          {% else %}
            <div class="no-blocks-message">
              No hay bloques programados para esta fecha. El inventario se muestra sin reservas activas.
            </div>
          {% endif %}
        </div>
      </div>
      <div class="availability-actions">
        <button type="submit" class="btn btn-secondary">Actualizar disponibilidad</button>
      </div>
    </form>
    <p class="availability-note">
      Mostrando reservas del <strong>{{ selected_date|date:"d/m/Y" }}</strong>
      {% if selected_block %}
        para <strong>{{ selected_block.label }}</strong>.
      {% else %}
        sin bloque disponible.
      {% endif %}
    </p>
  </div>

  {% if inventory %}
    <div class="table-container">
      <table class="data-table" id="inventoryTable">
        <thead>
          <tr>
            <th>Salón</th>
            <th>Material</th>
            <th>Cantidad</th>
            <th>Reservado (bloque)</th>
            <th>Disponible (bloque)</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in inventory %}
            <tr data-room="{{ item.room.code }}" data-material="{{ item.material.name }}" data-availability="{% if item.selected_availability_status == 'empty' %}empty{% else %}available{% endif %}">
              <td><strong>Salón {{ item.room.code }}</strong></td>
              <td>{{ item.material.name }}</td>
              <td>
                <span class="quantity-badge {% if item.quantity > 0 %}available{% else %}empty{% endif %}">
                  {{ item.quantity }} unidades
                </span>
              </td>
              <td>
                {% if has_block_schedule %}
                  <span class="quantity-badge reserved">{{ item.selected_reserved_quantity }}</span>
                {% else %}
                  <span class="quantity-badge available">0</span>
                {% endif %}
              </td>
              <td>
                {% if has_block_schedule %}
                  <span class="quantity-badge {% if item.selected_availability_status == 'ok' %}available{% elif item.selected_availability_status == 'warning' %}warning{% else %}empty{% endif %}">
                    {{ item.selected_available_quantity }}
                  </span>
                {% else %}
                  <span class="quantity-badge available">{{ item.quantity }}</span>
                {% endif %}
              </td>
              <td>
                {% if item.selected_availability_status == 'empty' %}
                  <span class="quantity-badge empty">Bloque sin disponibilidad</span>
                {% elif item.selected_availability_status == 'warning' %}
                  <span class="quantity-badge warning">Quedan pocas unidades</span>
                {% else %}
                  <span class="quantity-badge available">Disponible</span>
                {% endif %}
              </td>
              <td class="actions">
                <a href="/inventario/{{ item.pk }}/actualizar/" class="btn btn-sm btn-secondary">Actualizar</a>
                <a href="/inventario/{{ item.pk }}/eliminar/" class="btn btn-sm btn-danger">Eliminar</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Summary Section -->
    <div class="summary-section">
      <h3>Resumen por salón</h3>
      <div class="summary-grid">
        {% for room in rooms %}
          <div class="summary-card">
            <div class="summary-header">
              <h4>Salón {{ room.code }}</h4>
            </div>
            <div class="summary-content">
              {% for item in inventory %}
                {% if item.room.id == room.id %}
                  <div class="summary-item">
                    <span>{{ item.material.name }}</span>
                    <div class="summary-quantities">
                      <span class="quantity-badge {% if item.quantity > 0 %}available{% else %}empty{% endif %}" title="Inventario base">
                        {{ item.quantity }}
                      </span>
                      {% if has_block_schedule %}
                        <span class="quantity-badge reserved" title="Reservado en el bloque">
                          - {{ item.selected_reserved_quantity }}
                        </span>
                        <span class="quantity-badge {% if item.selected_availability_status == 'ok' %}available{% elif item.selected_availability_status == 'warning' %}warning{% else %}empty{% endif %}" title="Disponible en el bloque">
                          = {{ item.selected_available_quantity }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% else %}
    <div class="empty-state">
      <p>No hay inventario registrado.</p>
      <a href="/inventario/nuevo/" class="btn btn-primary">Agregar primer inventario</a>
    </div>
  {% endif %}
  
  <div class="navigation-links">
    <a href="/materiales/" class="btn btn-secondary">Gestionar materiales</a>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">Volver al inicio</a>
  </div>
</div>

<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
  filterTable();
});

// Filter functionality
document.getElementById('roomFilter').addEventListener('change', function() {
  filterTable();
});

document.getElementById('materialFilter').addEventListener('change', function() {
  filterTable();
});

document.getElementById('availabilityFilter').addEventListener('change', function() {
  filterTable();
});

function filterTable() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const roomFilter = document.getElementById('roomFilter').value;
  const materialFilter = document.getElementById('materialFilter').value;
  const availabilityFilter = document.getElementById('availabilityFilter').value;
  
  const rows = document.querySelectorAll('#inventoryTable tbody tr');
  
  rows.forEach(row => {
    const room = row.getAttribute('data-room');
    const material = row.getAttribute('data-material');
    const availability = row.getAttribute('data-availability');
    const text = row.textContent.toLowerCase();
    
    const matchesSearch = text.includes(searchTerm);
    const matchesRoom = !roomFilter || room === roomFilter;
    const matchesMaterial = !materialFilter || material === materialFilter;
    const matchesAvailability = !availabilityFilter || availability === availabilityFilter;
    
    if (matchesSearch && matchesRoom && matchesMaterial && matchesAvailability) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}
</script>

{% endblock %}
